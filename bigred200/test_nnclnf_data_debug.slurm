#!/bin/bash
#SBATCH --job-name=test_nnclnf
#SBATCH --output=test_nnclnf_%j.out
#SBATCH --error=test_nnclnf_%j.err
#SBATCH --time=00:15:00
#SBATCH --nodes=1
#SBATCH --ntasks=1
#SBATCH --cpus-per-task=4
#SBATCH --mem=16G
#SBATCH --account=r01984
#SBATCH --partition=debug

# DEBUG TEST: Generate NNCLNF training data for ONE video
#
# Uses the C++ ground truth from cpp_groundtruth_test (generated by debug test)
#
# Usage:
#   sbatch test_nnclnf_data_debug.slurm
#
# Prerequisites:
#   - Run test_cpp_groundtruth_debug.slurm first

set -e

module purge
module load python/3.12.11

cd "$HOME/pyfaceau"

export PYTHONPATH="$PWD:$PYTHONPATH"

# Configuration
VIDEO_DIR="S Data/Paralysis Cohort"
CPP_GT_DIR="cpp_groundtruth_test"
OUTPUT_DIR="nnclnf_training_data_test"
PDM_FILE="weights/In-the-wild_aligned_PDM_68.txt"

echo "============================================"
echo "DEBUG TEST: NNCLNF Training Data Generation"
echo "============================================"
echo "Job ID: $SLURM_JOB_ID"
echo "Start time: $(date)"
echo "============================================"

# Find the CSV from the debug test
CSV_FILE=$(ls "$CPP_GT_DIR"/*.csv 2>/dev/null | head -1)

if [ -z "$CSV_FILE" ] || [ ! -f "$CSV_FILE" ]; then
    echo "ERROR: No C++ ground truth found in $CPP_GT_DIR"
    echo "Run test_cpp_groundtruth_debug.slurm first!"
    exit 1
fi

VIDEO_NAME=$(basename "$CSV_FILE" .csv)

# Find video (handle both .MOV and .mov extensions)
if [ -f "$VIDEO_DIR/${VIDEO_NAME}.MOV" ]; then
    VIDEO="$VIDEO_DIR/${VIDEO_NAME}.MOV"
elif [ -f "$VIDEO_DIR/${VIDEO_NAME}.mov" ]; then
    VIDEO="$VIDEO_DIR/${VIDEO_NAME}.mov"
else
    echo "ERROR: Video not found: $VIDEO_DIR/${VIDEO_NAME}.[MOV|mov]"
    exit 1
fi

echo "Found C++ ground truth:"
echo "  CSV: $CSV_FILE"
echo "  Video: $VIDEO"

# Check PDM file exists
if [ ! -f "$PDM_FILE" ]; then
    echo "ERROR: PDM file not found: $PDM_FILE"
    exit 1
fi
echo "  PDM: $PDM_FILE"

# Create output directory
mkdir -p "$OUTPUT_DIR"
OUTPUT_FILE="$OUTPUT_DIR/training_${VIDEO_NAME}_test.h5"

echo ""
echo "Output: $OUTPUT_FILE"
echo ""

# Run data generator (first 100 frames for quick test)
echo "Running data generator (first 100 frames)..."
python3 -m nnclnf.data_generator \
    --video "$VIDEO" \
    --csv "$CSV_FILE" \
    --pdm "$PDM_FILE" \
    --output "$OUTPUT_FILE" \
    --max-frames 100 \
    --no-mtcnn

# Verify output
if [ -f "$OUTPUT_FILE" ]; then
    echo ""
    echo "SUCCESS! Output created: $OUTPUT_FILE"
    echo ""
    echo "Dataset contents:"
    python3 -c "
import h5py
import numpy as np
with h5py.File('$OUTPUT_FILE', 'r') as f:
    print('Datasets:')
    for key in f.keys():
        data = f[key][:]
        print(f'  {key}: {data.shape} {data.dtype}')
        if key == 'init_params':
            print(f'    Sample: scale={data[0,0]:.3f}, tx={data[0,4]:.1f}, ty={data[0,5]:.1f}')
        if key == 'target_params':
            print(f'    Sample: scale={data[0,0]:.3f}, tx={data[0,4]:.1f}, ty={data[0,5]:.1f}')
"
else
    echo "ERROR: Output file not created"
    exit 1
fi

echo ""
echo "============================================"
echo "DEBUG TEST PASSED!"
echo "End time: $(date)"
echo "============================================"
